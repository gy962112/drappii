<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product Details | Drapii Luxe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        :root {
            --accent: #9f2089;
            --accent-gradient: linear-gradient(135deg, #9f2089 0%, #ff5e9e 100%);
            --glass: rgba(248, 235, 255, 0.8); 
            --bg-page: #fdf8ff; 
            --text-main: #2d0c28;
            --text-muted: #8e6d8a;
            --card-radius: 32px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg-page); color: var(--text-main); padding-bottom: 120px; }

        header { 
            background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; 
            position: fixed; top: 0; width: 100%; z-index: 1000; 
            border-bottom: 1px solid rgba(159, 32, 137, 0.08);
        }
        .back-btn { font-size: 20px; color: var(--accent); cursor: pointer; }

        /* Full Image View - Flipkart Style */
        .image-gallery { 
            background: #fff; width: 100%; height: 75vh; /* Fix for full image height */
            overflow: hidden; margin-top: 0; position: relative;
            display: flex;
        }
        .slider-container {
            display: flex; width: 100%; height: 100%;
            overflow-x: scroll; scroll-snap-type: x mandatory;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .slider-container::-webkit-scrollbar { display: none; }
        .slider-item { min-width: 100%; height: 100%; scroll-snap-align: start; }
        .slider-item img { width: 100%; height: 100%; object-fit: contain; background: #fff; } /* 'contain' ensures full image is visible */
        
        .slider-dots {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; z-index: 20;
        }
        .dot { width: 6px; height: 6px; background: rgba(159, 32, 137, 0.2); border-radius: 50%; transition: 0.3s; }
        .dot.active { width: 22px; border-radius: 10px; background: var(--accent); }

        .luxe-card { 
            background: #fff; padding: 30px 25px; 
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            margin-top: -35px; position: relative; z-index: 10;
            box-shadow: 0 -15px 40px rgba(159, 32, 137, 0.05);
            border: 1px solid rgba(159, 32, 137, 0.03);
        }

        .p-title { font-size: 22px; font-weight: 800; color: var(--text-main); line-height: 1.3; margin-bottom: 12px; letter-spacing: -0.5px; }
        .price-row { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; }
        .current-price { font-size: 30px; font-weight: 800; color: var(--text-main); }
        .mrp { font-size: 16px; text-decoration: line-through; color: var(--text-muted); }
        .discount-pct { 
            font-size: 13px; color: #fff; font-weight: 800; 
            background: var(--accent-gradient); padding: 5px 12px; border-radius: 12px;
        }

        .section-title { font-size: 13px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); margin-bottom: 15px; margin-top: 10px; }
        
        /* Color Selector */
        .color-chips { display: flex; gap: 10px; margin-bottom: 20px; }
        .color-circle { 
            width: 35px; height: 35px; border-radius: 50%; border: 2px solid #eee; 
            cursor: pointer; transition: 0.3s; position: relative;
        }
        .color-circle.selected { border-color: var(--accent); transform: scale(1.1); }
        .color-circle.selected::after {
            content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .variant-chips { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .chip { 
            min-width: 60px; text-align: center; border: 1.5px solid rgba(159, 32, 137, 0.1); 
            padding: 10px; border-radius: 15px; font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .chip.selected { border-color: var(--accent); color: #fff; background: var(--accent); }

        /* Similar Products Grid */
        .similar-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 0;
        }
        .sim-card { 
            background: #fff; border-radius: 20px; overflow: hidden; 
            border: 1px solid rgba(159, 32, 137, 0.05); box-shadow: 0 5px 15px rgba(0,0,0,0.02);
        }
        .sim-card img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .sim-info { padding: 10px; }
        .sim-name { font-size: 12px; font-weight: 600; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sim-price { font-size: 14px; font-weight: 800; color: var(--text-main); }

        .sticky-footer { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px; 
            background: rgba(45, 12, 40, 0.95); backdrop-filter: blur(15px);
            display: grid; grid-template-columns: 1fr 1fr; 
            padding: 12px; gap: 12px; border-radius: 26px; z-index: 1000;
            box-shadow: 0 15px 35px rgba(45, 12, 40, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-footer { padding: 16px; border: none; border-radius: 20px; font-size: 15px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .cart-btn { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .buy-btn { background: #fff; color: #2d0c28; }
        .fav-btn {
            width: 50px; height: 50px; border-radius: 50%; background: #fff;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(159, 32, 137, 0.1); position: absolute;
            top: -25px; right: 25px; font-size: 22px; color: #ff4d4d; z-index: 100;
        }
    </style>
</head>
<body>

    <header>
        <i class="fa-solid fa-chevron-left back-btn" onclick="location.href='index.html'"></i>
        <div style="display:flex; gap:20px; font-size:18px;">
            <a href="cart.html" style="color:var(--text-main);"><i class="fa-solid fa-bag-shopping"></i></a>
        </div>
    </header>

    <div class="image-gallery">
        <div class="slider-container" id="imageSlider"></div>
        <div class="slider-dots" id="sliderDots"></div>
    </div>

    <div class="luxe-card">
        <div class="fav-btn"><i class="fa-regular fa-heart"></i></div>
        <h1 id="pName" class="p-title">Drapii Luxe Collection</h1>
        
        <div class="price-row">
            <span id="pPrice" class="current-price">₹--</span>
            <span id="pMrp" class="mrp">₹--</span>
            <span id="pDisc" class="discount-pct">--% OFF</span>
        </div>

        <div class="section-title">Select Color</div>
        <div class="color-chips" id="colorList">
            <div class="color-circle selected" style="background:#2d0c28" onclick="selectColor(this)"></div>
            <div class="color-circle" style="background:#9f2089" onclick="selectColor(this)"></div>
            <div class="color-circle" style="background:#555" onclick="selectColor(this)"></div>
        </div>

        <div class="section-title">Selection Size</div>
        <div id="sizeList" class="variant-chips"></div>

        <div class="section-title">Description</div>
        <p id="pDesc" style="font-size:14px; color:var(--text-muted); line-height:1.7; margin-bottom:20px;">Loading...</p>

        <div class="section-title">Similar Products</div>
        <div class="similar-grid" id="similarGrid"></div>
    </div>

    <div class="sticky-footer">
        <button id="addBagBtn" class="btn-footer cart-btn" onclick="addToCart(false)">
            <i class="fa-solid fa-bag-shopping"></i> Bag
        </button>
        <button id="buyNowBtn" class="btn-footer buy-btn" onclick="addToCart(true)">
            Buy Now <i class="fa-solid fa-bolt"></i>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, where, limit, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAktuzpc6myYe-szK-GbTQdn_Iu0bYQW8Q",
            authDomain: "fashora-flipkart.firebaseapp.com",
            projectId: "fashora-flipkart",
            storageBucket: "fashora-flipkart.firebasestorage.app",
            messagingSenderId: "383843603520",
            appId: "1:383843603520:web:729cb5ac9437eb7b1cbba5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        let productData = null;
        let selectedSize = "";
        let firstMainImage = ""; 

        function extractImageUrl(input) {
            if (!input) return "";
            if (input.startsWith('http')) return input.replace(/['"]+/g, '').trim();
            const match = input.match(/src="([^"]+)"/);
            return match ? match[1] : input.replace(/['"]+/g, '').trim();
        }

        window.selectSize = (el) => {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedSize = el.innerText;
        };

        window.selectColor = (el) => {
            document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        };

        async function loadProduct() {
            if (!productId) { window.location.href = 'index.html'; return; }
            try {
                const docSnap = await getDoc(doc(db, "products", productId));
                if (docSnap.exists()) {
                    productData = docSnap.data();
                    const imageInput = productData.image || "";
                    const imgUrls = imageInput.split(',').map(u => extractImageUrl(u.trim())).filter(u => u !== "");
                    firstMainImage = imgUrls[0];

                    let sliderHtml = "";
                    let dotsHtml = "";
                    imgUrls.forEach((url, i) => {
                        sliderHtml += `<div class="slider-item"><img src="${url}"></div>`;
                        dotsHtml += `<div class="dot ${i === 0 ? 'active' : ''}"></div>`;
                    });
                    
                    document.getElementById('imageSlider').innerHTML = sliderHtml;
                    document.getElementById('sliderDots').innerHTML = dotsHtml;
                    document.getElementById('pName').innerText = productData.name;
                    document.getElementById('pPrice').innerText = "₹" + Number(productData.price).toLocaleString();
                    document.getElementById('pDesc').innerText = productData.description || "No description available.";

                    const mrp = Math.round((productData.price || 0) * 1.35);
                    document.getElementById('pMrp').innerText = "₹" + mrp.toLocaleString();
                    document.getElementById('pDisc').innerText = "35% OFF";

                    if(productData.sizes) {
                        let sizeHtml = "";
                        productData.sizes.forEach((s, index) => {
                            const active = index === 0 ? "selected" : "";
                            if(index === 0) selectedSize = s;
                            sizeHtml += `<div class="chip ${active}" onclick="selectSize(this)">${s}</div>`;
                        });
                        document.getElementById('sizeList').innerHTML = sizeHtml;
                    }
                    loadSimilarProducts(productData.category);
                }
            } catch (error) { console.error(error); }
        }

        async function loadSimilarProducts(category) {
            const q = query(collection(db, "products"), where("category", "==", category), limit(4));
            const snap = await getDocs(q);
            let html = "";
            snap.forEach(doc => {
                if(doc.id !== productId) {
                    const data = doc.data();
                    html += `
                        <div class="sim-card" onclick="location.href='product.html?id=${doc.id}'">
                            <img src="${extractImageUrl(data.image)}">
                            <div class="sim-info">
                                <p class="sim-name">${data.name}</p>
                                <p class="sim-price">₹${data.price}</p>
                            </div>
                        </div>`;
                }
            });
            document.getElementById('similarGrid').innerHTML = html;
        }

        window.addToCart = async function(isBuyNow) {
            const user = auth.currentUser;
            if (!user) { window.location.href='signup.html'; return; }
            if(isBuyNow) {
                localStorage.setItem('checkoutItem', JSON.stringify({
                    name: productData.name, price: Number(productData.price),
                    image: firstMainImage, size: selectedSize, productId: productId
                }));
                window.location.href = 'checkout.html';
            } else {
                await addDoc(collection(db, "carts"), {
                    userId: user.uid, productId: productId,
                    name: productData.name, price: Number(productData.price),
                    image: firstMainImage, size: selectedSize, timestamp: serverTimestamp()
                });
                window.location.href = 'cart.html';
            }
        };

        const slider = document.getElementById('imageSlider');
        slider.addEventListener('scroll', () => {
            const index = Math.round(slider.scrollLeft / slider.offsetWidth);
            document.querySelectorAll('.dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        });

        loadProduct();
    </script>
</body>
</html>
