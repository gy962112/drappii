<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Panel | Drapii Luxe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { 
            --pink: #f43397; 
            --bg: #f7f9fc; 
            --dark: #1e293b; 
            --success: #16a34a; 
            --gray: #94a3b8; 
            --flipkart-blue: #2874f0; 
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body { 
            background: var(--bg); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding: 40px 20px; 
        }

        .container, #authSection {
            background: #ffffff;
            border-radius: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 30px;
        }

        #authSection { width: 100%; max-width: 450px; display: none; margin-top: 50px; }
        .container { width: 100%; max-width: 900px; display: none; }

        .auth-tabs { display: flex; background: #f1f5f9; padding: 6px; border-radius: 14px; margin-bottom: 25px; }
        .auth-tab { flex:1; padding:12px; border:none; border-radius:10px; cursor:pointer; font-weight:700; color:#64748b; background:transparent; font-size: 13px; transition: 0.3s; }
        .auth-tab.active { background:#fff; color:var(--pink); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .wh-profile-card { background: #fff; border-radius: 20px; overflow: hidden; margin-bottom: 30px; border: 1px solid #f0f0f0; }
        .wh-banner { width: 100%; height: 200px; object-fit: cover; background: #f8fafc; border-bottom: 4px solid var(--pink); }
        .wh-info { padding: 20px; }

        label { display: block; font-size: 12px; font-weight: 800; margin-bottom: 8px; color: #475569; text-transform: uppercase; margin-top: 15px; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1.5px solid #e2e8f0; border-radius: 14px; outline: none; font-size: 14px; margin-bottom: 12px; background: #fff; transition: 0.3s; }
        input:focus { border-color: var(--pink); box-shadow: 0 0 0 4px rgba(244, 51, 151, 0.1); }
        
        .size-chips, .color-chips { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .size-chip, .color-chip { padding: 10px 18px; border: 1.5px solid #e2e8f0; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.2s; background: #fff; }
        .size-chip.selected, .color-chip.selected { background: var(--pink); color: #fff; border-color: var(--pink); transform: translateY(-2px); }

        .btn-main { width: 100%; padding: 16px; background: var(--pink); color: #fff; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 10px; box-shadow: 0 4px 15px rgba(244, 51, 151, 0.3); }
        .btn-main:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-main:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }

        .upload-area { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 16px; background: #f8fafc; cursor: pointer; margin-bottom: 15px; transition: 0.3s; }
        .upload-area:hover { border-color: var(--pink); background: #fef1f8; }
        .upload-area img { max-width: 100%; max-height: 200px; display: none; margin: 15px auto; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .hidden { display: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--dark); color: white; padding: 25px; border-radius: 20px; text-align: left; position: relative; overflow: hidden; }
        .stat-box h4 { font-size: 14px; opacity: 0.8; margin-bottom: 5px; }
        
        .order-card { background:#fff; border-radius:16px; padding:20px; margin-bottom:15px; border:1px solid #f0f0f0; transition: 0.3s; }
        .order-card:hover { border-color: var(--pink); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 45px; height: 45px; border: 5px solid #f3f3f3; border-top: 5px solid var(--pink); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .product-item { background: #fff; padding: 15px; border-radius: 18px; display: flex; align-items: center; gap: 15px; margin-top: 12px; border: 1px solid #f0f0f0; transition: 0.3s; }
        .product-item:hover { transform: scale(1.01); }
        .product-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 12px; }
        .product-info h5 { font-size: 15px; color: var(--dark); margin-bottom: 4px; }
        
        .listing-section { background: #fff; padding: 25px; border-radius: 20px; border: 1px solid #f0f0f0; margin-bottom: 25px; }
        .section-title { font-size: 13px; color: var(--flipkart-blue); font-weight: 800; margin-bottom: 20px; border-left: 4px solid var(--flipkart-blue); padding-left: 12px; letter-spacing: 1px; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--pink); }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; border-radius: 0; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-weight:700; color:var(--dark)">Setting up Warehouse...</p>
    </div>

    <div id="authSection">
        <div style="text-align: center; margin-bottom: 25px;">
            <i class="fa-solid fa-warehouse" style="font-size: 45px; color: var(--pink);"></i>
            <h2 style="margin-top:15px; font-weight: 800; color: var(--dark);">Seller Hub</h2>
            <p style="color: var(--gray); font-size: 14px;">Manage your inventory & orders</p>
        </div>
        <div class="auth-tabs">
            <button class="auth-tab active" id="loginTabBtn" onclick="toggleAuth('login')">Login</button>
            <button class="auth-tab" id="signupTabBtn" onclick="toggleAuth('signup')">Register</button>
        </div>
        <div id="loginFields">
            <input type="email" id="logEmail" placeholder="Email Address">
            <input type="password" id="logPass" placeholder="Password">
            <button class="btn-main" id="loginBtn" onclick="login()">Enter Warehouse</button>
        </div>
        <div id="signupFields" class="hidden">
            <input type="text" id="regName" placeholder="Warehouse Name">
            
            <label>Warehouse City</label>
            <select id="regCity" onchange="checkNewCity(this.value)">
                <option value="">Select Your City</option>
                <option value="Agra">Agra</option>
                <option value="Delhi">Delhi</option>
                <option value="Mumbai">Mumbai</option>
                <option value="Jaipur">Jaipur</option>
                <option value="Surat">Surat</option>
                <option value="Bangalore">Bangalore</option>
                <option value="Lucknow">Lucknow</option>
                <option value="Kolkata">Kolkata</option>
                <option value="Ahmedabad">Ahmedabad</option>
                <option value="NEW_CITY" style="color:var(--pink); font-weight:bold;">+ Add New City</option>
            </select>
            <input type="text" id="newCityInput" class="hidden" placeholder="Enter Your City Name (e.g. Pune)">

            <textarea id="regAddr" placeholder="Full Address with Landmark" style="height: 80px;"></textarea>
            <label>Warehouse Image URL</label>
            <input type="url" id="regWhUrl" placeholder="Paste image link here">
            <input type="email" id="regEmail" placeholder="Email Address">
            <input type="password" id="regPass" placeholder="Create Password">
            <button class="btn-main" id="signupBtn" onclick="signup()">Create Warehouse Account</button>
        </div>
    </div>

    <div class="container" id="dashboardSection">
        <div class="header-bar" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;">
            <div>
                <h2 id="welcomeName" style="font-weight:800; color: var(--dark);">Warehouse</h2>
                <span id="displayWhCity" style="font-size:12px; background:var(--pink); color:#fff; padding:4px 12px; border-radius:20px; font-weight:700; display: inline-block; margin-top: 5px;"></span>
            </div>
            <button class="btn-main" onclick="logout()" style="width:auto; padding:10px 20px; background:#fee2e2; color:#ef4444; box-shadow: none;"><i class="fa-solid fa-power-off"></i> Logout</button>
        </div>

        <div class="wh-profile-card">
            <img id="displayWhImg" class="wh-banner" src="">
            <div class="wh-info">
                <p id="displayWhAddr" style="font-size: 14px; font-weight: 600; color:#64748b"></p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <i class="fa-solid fa-box-open" style="position:absolute; right:15px; bottom:15px; font-size:50px; opacity:0.1"></i>
                <h4>Orders Received</h4>
                <p id="totalOrdersCount" style="font-size:32px; font-weight:800">0</p>
            </div>
            <div class="stat-box" style="background:var(--pink)">
                <i class="fa-solid fa-indian-rupee-sign" style="position:absolute; right:15px; bottom:15px; font-size:50px; opacity:0.1"></i>
                <h4>Total Payout (80%)</h4>
                <p id="totalPayoutAmt" style="font-size:32px; font-weight:800">â‚¹0</p>
            </div>
        </div>

        <div class="auth-tabs" style="background:#f8fafc; border:1px solid #e2e8f0; padding: 8px;">
            <button class="auth-tab active" id="addTab" onclick="switchDash('add')"><i class="fa-solid fa-plus-circle"></i> Add Product</button>
            <button class="auth-tab" id="orderTab" onclick="switchDash('orders')"><i class="fa-solid fa-truck-fast"></i> Live Orders</button>
            <button class="auth-tab" id="payTab" onclick="switchDash('pay')"><i class="fa-solid fa-bank"></i> Bank Settings</button>
        </div>

        <div id="addProductUI">
            <div class="listing-section">
                <div class="section-title">MEDIA & VISUALS</div>
                <div class="upload-area" onclick="document.getElementById('pImg').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 30px; color: var(--pink); margin-bottom: 10px;"></i><br>
                    <strong>Click to Upload Photo</strong>
                    <p style="font-size: 12px; color: var(--gray);">PNG, JPG (Max 5MB)</p>
                    <img id="pImgPrev">
                </div>
                <input type="file" id="pImg" hidden onchange="previewImg(this, 'pImgPrev')">
                <textarea id="pImgUrl" placeholder="OR Paste Image URL (For multiple images, separate by comma ',') " style="height: 60px;"></textarea>
            </div>

            <div class="listing-section">
                <div class="section-title">LISTING INFORMATION</div>
                <label>Category Details</label>
                <select id="pCategory" onchange="checkNewCat(this.value)">
                    <option value="">Select Category</option>
                    <option value="Saree">Saree</option>
                    <option value="Kurti">Kurti / Ethnic Wear</option>
                    <option value="Shirt">Mens Shirt</option>
                    <option value="Pant">Pant / Trousers</option>
                    <option value="Child">Child / Kids Wear</option>
                    <option value="Suits">Unstitched Suits</option>
                    <option value="Western">Western Wear</option>
                    <option value="Jewellery">Jewellery & Acc.</option>
                    <option value="Footwear">Footwear / Shoes</option>
                    <option value="NEW" style="color:var(--pink); font-weight:bold;">+ Add New Category</option>
                </select>
                <input type="text" id="newCatInput" class="hidden" placeholder="Enter New Category Name">
                
                <div id="catSpecifics" class="hidden" style="background: #f1f5f9; padding: 15px; border-radius: 14px; margin-top: 10px; border: 1px solid #e2e8f0;">
                    <p style="font-size: 11px; font-weight: 800; color: var(--pink); margin-bottom: 10px; letter-spacing: 1px;">COMPLETE PRODUCT SPECIFICATIONS</p>
                    <div id="dynamicFieldsContainer"></div>
                </div>

                <label>Brand Name</label>
                <input type="text" id="pBrand" placeholder="Brand Name (e.g. Drapii Luxe)">
                <label>Product Title</label>
                <input type="text" id="pName" placeholder="Product Title (Full Name)">
                <label>Description</label>
                <textarea id="pDesc" placeholder="Description (Bullet points recommended)" style="height: 100px;"></textarea>
            </div>

            <div class="listing-section">
                <div class="section-title">VARIATIONS (SIZES & COLORS)</div>
                <label>Available Sizes</label>
                <div class="size-chips" id="sizeContainer">
                    <div class="size-chip" onclick="toggleSize(this)">S</div>
                    <div class="size-chip" onclick="toggleSize(this)">M</div>
                    <div class="size-chip" onclick="toggleSize(this)">L</div>
                    <div class="size-chip" onclick="toggleSize(this)">XL</div>
                    <div class="size-chip" onclick="toggleSize(this)">XXL</div>
                    <div class="size-chip" onclick="toggleSize(this)">Free Size</div>
                </div>
                <label>Available Colors</label>
                <div class="color-chips" id="colorContainer">
                    <div class="color-chip" onclick="toggleColor(this)">Red</div>
                    <div class="color-chip" onclick="toggleColor(this)">Blue</div>
                    <div class="color-chip" onclick="toggleColor(this)">Green</div>
                    <div class="color-chip" onclick="toggleColor(this)">Black</div>
                    <div class="color-chip" onclick="toggleColor(this)">White</div>
                    <div class="color-chip" onclick="toggleColor(this)">Pink</div>
                    <div class="color-chip" onclick="toggleColor(this)">Yellow</div>
                    <div class="color-chip" onclick="toggleColor(this)">Multi</div>
                    <div class="color-chip" onclick="toggleColor(this)">Grey</div>
                    <div class="color-chip" onclick="toggleColor(this)">Brown</div>
                </div>
            </div>

            <div class="listing-section">
                <div class="section-title">PRICE & STOCK MANAGEMENT</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <div><label>MRP (â‚¹)</label><input type="number" id="pMrp" placeholder="Original Price"></div>
                    <div><label>Selling Price (â‚¹)</label><input type="number" id="pPrice" placeholder="Discounted Price"></div>
                    <div><label>In Stock (Qty)</label><input type="number" id="pStock" placeholder="Total Units"></div>
                    <div><label>SKU ID</label><input type="text" id="pSku" placeholder="e.g. DRP-001"></div>
                </div>
            </div>

            <div class="listing-section">
                <div class="section-title">LOGISTICS & TAX</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <div><label>HSN Code</label><input type="text" id="pHsn" placeholder="8-digit code"></div>
                    <div><label>GST (%)</label><select id="pGst"><option value="5">5%</option><option value="12">12%</option><option value="18">18%</option></select></div>
                </div>
            </div>

            <button class="btn-main" id="uploadBtn" onclick="uploadProduct()" style="margin-bottom: 40px;">Launch Product to Drapii Luxe</button>

            <div style="margin-top: 30px;">
                <h4 style="font-weight: 800; color: var(--dark); border-bottom: 3px solid var(--pink); display: inline-block; padding-bottom: 5px; margin-bottom: 15px;">Live Inventory</h4>
                <div id="sellerProductList" style="margin-top: 10px;"></div>
            </div>
        </div>

        <div id="ordersUI" class="hidden"><div id="ordersList"></div></div>

        <div id="payUI" class="hidden">
            <div style="background: #fff; padding: 25px; border-radius: 20px; border: 1px solid #f0f0f0;">
                <h3 style="margin-bottom: 20px; color: var(--dark);"><i class="fa-solid fa-building-columns" style="color:var(--pink)"></i> Settlement Bank Account</h3>
                <label>Account Holder Name</label><input type="text" id="accHolder">
                <label>Account Number</label><input type="text" id="accNumber">
                <label>Bank Name</label><input type="text" id="bankName">
                <label>IFSC Code</label><input type="text" id="ifscCode">
                <button class="btn-main" id="bankSaveBtn" onclick="updateBankDetails()">Update Bank Information</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAktuzpc6myYe-szK-GbTQdn_Iu0bYQW8Q", 
            authDomain: "fashora-flipkart.firebaseapp.com", 
            projectId: "fashora-flipkart", 
            storageBucket: "fashora-flipkart.firebasestorage.app", 
            messagingSenderId: "383843603520", 
            appId: "1:383843603520:web:729cb5ac9437eb7b1cbba5" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let sellerId = "";
        let sellerCity = ""; 
        let selectedSizes = [];
        let selectedColors = [];

        // Notification variable to track previous count
        let lastOrderCount = -1;

        const categoryConfigs = {
            "Saree": {
                "Fabric": ["Cotton", "Silk", "Georgette", "Chiffon", "Net", "Organza", "Linen", "Banarasi"],
                "Work": ["Zari", "Embroidery", "Printed", "Stone Work", "Lace Border", "Plain", "Mirror Work"],
                "Blouse": ["Stitched", "Unstitched", "Separated", "No Blouse"],
                "Occasion": ["Wedding", "Casual", "Party", "Festive"]
            },
            "Kurti": {
                "Fabric": ["Rayon", "Cotton", "Crepe", "Georgette", "Silk", "Linen"],
                "Pattern": ["Anarkali", "Straight", "A-Line", "Short Kurti", "Angrakha"],
                "Sleeve": ["Full Sleeve", "3/4 Sleeve", "Half Sleeve", "Sleeveless"],
                "Length": ["Knee Length", "Calf Length", "Ankle Length"]
            },
            "Shirt": {
                "Fabric": ["Cotton", "Linen", "Denim", "Satin", "Polyester", "Checkered"],
                "Fit": ["Slim Fit", "Regular Fit", "Relaxed Fit", "Oversized"],
                "Sleeve": ["Full Sleeve", "Half Sleeve"],
                "Collar": ["Spread", "Button Down", "Mandarin", "Club"]
            },
            "Pant": {
                "Type": ["Chinos", "Trousers", "Formal", "Jeans", "Joggers"],
                "Fabric": ["Cotton Blend", "Denim", "Stretchable Silk", "Wool"],
                "Fit": ["Slim Fit", "Skinny", "Straight Leg", "Tapered"]
            },
            "Child": {
                "Age Group": ["0-6 Months", "6-12 Months", "1-2 Years", "2-3 Years", "3-5 Years", "5-7 Years", "7-10 Years", "10-12 Years", "12-15 Years"],
                "Fabric": ["Cotton", "Hosiery", "Soft Denim", "Silk Blend"],
                "Type": ["Frock", "T-Shirt & Shorts", "Suit", "Nightwear", "Ethic Wear"]
            },
            "Footwear": {
                "Material": ["Synthetic Leather", "Canvas", "Mesh", "Rubber", "PVC", "Suede"],
                "Sole": ["Airmix", "Rubber", "PVC", "TPR", "Leather Sole"],
                "Type": ["Sneakers", "Loafers", "Formal Shoes", "Sandals", "Heels", "Boots"],
                "Closure": ["Lace-Up", "Slip-On", "Velcro", "Buckle"]
            },
            "Jewellery": {
                "Material": ["Gold Plated", "Silver Plated", "Oxidised", "Beads", "Pearl", "American Diamond"],
                "Type": ["Necklace Set", "Earrings", "Bangles", "Ring", "Anklet", "Maang Tikka"],
                "Occasion": ["Bridal", "Everyday", "Party Wear"]
            }
        };

        window.login = async () => {
            const email = document.getElementById('logEmail').value;
            const pass = document.getElementById('logPass').value;
            if(!email || !pass) return alert("Fill all fields");
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (e) { alert("Login Error: " + e.message); }
        };

        window.signup = async () => {
            const name = document.getElementById('regName').value;
            const city = document.getElementById('regCity').value === 'NEW_CITY' ? document.getElementById('newCityInput').value : document.getElementById('regCity').value;
            const addr = document.getElementById('regAddr').value;
            const img = document.getElementById('regWhUrl').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            if(!email || !pass || !name) return alert("Fill all fields");
            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "sellers", res.user.uid), {
                    warehouseName: name, warehouseCity: city, address: addr, warehouseImg: img, email: email, role: 'seller', createdAt: serverTimestamp()
                });
            } catch (e) { alert("Signup Error: " + e.message); }
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            if (user) {
                // Request notification permission on login
                if (Notification.permission !== 'granted') {
                    Notification.requestPermission();
                }

                const sDoc = await getDoc(doc(db, "sellers", user.uid));
                if(sDoc.exists()){
                    sellerId = user.uid; const d = sDoc.data(); sellerCity = d.warehouseCity;
                    document.getElementById('welcomeName').innerText = d.warehouseName;
                    document.getElementById('displayWhCity').innerText = sellerCity;
                    document.getElementById('displayWhImg').src = d.warehouseImg;
                    document.getElementById('displayWhAddr').innerText = d.address;
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                    loadStats(); 
                    loadSellerProducts();
                } else { await signOut(auth); alert("Not a seller account"); }
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('dashboardSection').style.display = 'none';
            }
            loader.style.display = 'none';
        });

        window.toggleAuth = (m) => {
            document.getElementById('loginFields').classList.toggle('hidden', m==='signup');
            document.getElementById('signupFields').classList.toggle('hidden', m==='login');
            document.getElementById('loginTabBtn').classList.toggle('active', m==='login');
            document.getElementById('signupTabBtn').classList.toggle('active', m==='signup');
        };

        window.toggleSize = (el) => { 
            el.classList.toggle('selected'); 
            const s = el.innerText; 
            if(selectedSizes.includes(s)) {
                selectedSizes = selectedSizes.filter(x => x !== s);
            } else {
                selectedSizes.push(s);
            }
        };

        window.toggleColor = (el) => { 
            el.classList.toggle('selected'); 
            const c = el.innerText; 
            if(selectedColors.includes(c)) {
                selectedColors = selectedColors.filter(x => x !== c);
            } else {
                selectedColors.push(c);
            }
        };

        window.checkNewCity = (val) => { document.getElementById('newCityInput').classList.toggle('hidden', val !== 'NEW_CITY'); };

        window.checkNewCat = (val) => {
            const input = document.getElementById('newCatInput');
            const specificsDiv = document.getElementById('catSpecifics');
            const container = document.getElementById('dynamicFieldsContainer');
            const sizeContainer = document.getElementById('sizeContainer');
            
            container.innerHTML = "";
            selectedSizes = []; 
            selectedColors = [];
            document.querySelectorAll('.size-chip, .color-chip').forEach(chip => chip.classList.remove('selected'));

            if(val === 'Footwear') {
                sizeContainer.innerHTML = `
                    <div class="size-chip" onclick="toggleSize(this)">6</div>
                    <div class="size-chip" onclick="toggleSize(this)">7</div>
                    <div class="size-chip" onclick="toggleSize(this)">8</div>
                    <div class="size-chip" onclick="toggleSize(this)">9</div>
                    <div class="size-chip" onclick="toggleSize(this)">10</div>
                `;
            } else {
                sizeContainer.innerHTML = `
                    <div class="size-chip" onclick="toggleSize(this)">S</div>
                    <div class="size-chip" onclick="toggleSize(this)">M</div>
                    <div class="size-chip" onclick="toggleSize(this)">L</div>
                    <div class="size-chip" onclick="toggleSize(this)">XL</div>
                    <div class="size-chip" onclick="toggleSize(this)">XXL</div>
                    <div class="size-chip" onclick="toggleSize(this)">Free Size</div>
                `;
            }

            if(val === 'NEW') {
                input.classList.remove('hidden'); specificsDiv.classList.add('hidden');
            } else if(categoryConfigs[val]) {
                input.classList.add('hidden'); specificsDiv.classList.remove('hidden');
                Object.entries(categoryConfigs[val]).forEach(([fieldName, options]) => {
                    const lbl = document.createElement('label');
                    lbl.innerText = fieldName;
                    lbl.style.fontSize = "10px";
                    const sel = document.createElement('select');
                    sel.className = "cat-extra-field";
                    sel.dataset.fieldname = fieldName;
                    let optionsHTML = `<option value="">Select ${fieldName}</option>`;
                    options.forEach(opt => { optionsHTML += `<option value="${opt}">${opt}</option>`; });
                    sel.innerHTML = optionsHTML;
                    container.appendChild(lbl);
                    container.appendChild(sel);
                });
            } else {
                input.classList.add('hidden'); specificsDiv.classList.add('hidden');
            }
        };

        window.switchDash = (tab) => {
            ['addProductUI', 'ordersUI', 'payUI'].forEach(id => document.getElementById(id).classList.add('hidden'));
            ['addTab', 'orderTab', 'payTab'].forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById(tab === 'add' ? 'addProductUI' : tab === 'orders' ? 'ordersUI' : 'payUI').classList.remove('hidden');
            document.getElementById(tab === 'add' ? 'addTab' : tab === 'orders' ? 'orderTab' : 'payTab').classList.add('active');
        };

        window.previewImg = (input, targetId) => {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => { const img = document.getElementById(targetId); img.src = e.target.result; img.style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        };

        window.uploadProduct = async () => {
            const btn = document.getElementById('uploadBtn');
            let categoryValue = document.getElementById('pCategory').value;
            if(categoryValue === 'NEW') categoryValue = document.getElementById('newCatInput').value;
            if(!categoryValue) return alert("Select Category");
            if(selectedSizes.length === 0) return alert("Select at least one size");

            const extraFields = {};
            document.querySelectorAll('.cat-extra-field').forEach(sel => {
                if(sel.value) extraFields[sel.dataset.fieldname] = sel.value;
            });

            btn.disabled = true; btn.innerText = "Launching...";
            try {
                const file = document.getElementById('pImg').files[0];
                let finalUrl = document.getElementById('pImgUrl').value;
                if(file) {
                    const sRef = ref(storage, `products/${Date.now()}`);
                    await uploadBytes(sRef, file);
                    finalUrl = await getDownloadURL(sRef);
                }
                await addDoc(collection(db, "products"), {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrand').value,
                    category: categoryValue,
                    specifications: extraFields,
                    mrp: Number(document.getElementById('pMrp').value),
                    price: Number(document.getElementById('pPrice').value),
                    stock: Number(document.getElementById('pStock').value),
                    sku: document.getElementById('pSku').value,
                    image: finalUrl,
                    sizes: selectedSizes,
                    colors: selectedColors,
                    sellerId: sellerId,
                    warehouseCity: sellerCity,
                    timestamp: Date.now()
                });
                alert("Product Launched!"); location.reload();
            } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "Launch Product"; }
        };

        function loadSellerProducts() {
            if(!sellerId) return;
            const q = query(collection(db, "products"), where("sellerId", "==", sellerId));
            onSnapshot(q, (snap) => {
                let html = "";
                snap.forEach(docSnap => {
                    const p = docSnap.data();
                    html += `<div class="product-item"><img src="${p.image.split(',')[0]}"><div class="product-info"><h5>${p.name}</h5><p>â‚¹${p.price} | ${p.category}</p></div><button class="delete-btn" style="color: #ef4444; background: #fee2e2; border: none; padding: 10px; border-radius: 10px; cursor: pointer;" onclick="deleteMyProduct('${docSnap.id}')"><i class="fa-solid fa-trash"></i></button></div>`;
                });
                document.getElementById('sellerProductList').innerHTML = html || "<p>No products.</p>";
            });
        }

        window.deleteMyProduct = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "products", id)); };

        // Real-time Live Orders & Payout Logic
        async function loadStats() {
            if(!sellerId) return;
            const q = query(collection(db, "orders"), where("sellerId", "==", sellerId));
            
            onSnapshot(q, (snap) => {
                const currentCount = snap.size;
                
                // TRIGGER NOTIFICATION LOGIC
                if (lastOrderCount !== -1 && currentCount > lastOrderCount) {
                    if (Notification.permission === 'granted') {
                        new Notification("New Order Received! ðŸ“¦", {
                            body: "You have a new order in your Warehouse Panel.",
                            icon: "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/warehouse.svg"
                        });
                    }
                }
                lastOrderCount = currentCount;

                document.getElementById('totalOrdersCount').innerText = currentCount;
                
                let earnings = 0; 
                let html = "";
                
                snap.forEach(docSnap => {
                    const o = docSnap.data();
                    const docId = docSnap.id;
                    
                    if(o.status === 'Delivered') {
                        earnings += (Number(o.price) || 0) * 0.8;
                    }
                    
                    const statusColor = o.status === 'Delivered' ? 'var(--success)' : o.status === 'Cancelled' ? '#ef4444' : 'var(--flipkart-blue)';

                    html += `
                        <div class="order-card">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <h4 style="color:var(--dark)">${o.productName || 'Product Name'}</h4>
                                    <p style="font-size:13px; color:var(--gray); margin:4px 0;">Size: ${o.size || 'N/A'} | Price: â‚¹${o.price}</p>
                                    <p style="font-size:12px; margin-top:5px;">Status: <b style="color:${statusColor}">${o.status || 'Pending'}</b></p>
                                </div>
                                <div style="text-align:right">
                                    <span style="font-size:10px; color:var(--gray)">ID: ${docId.substring(0,8)}</span>
                                </div>
                            </div>
                            
                            <div style="background:#f8fafc; padding:10px; border-radius:10px; margin-top:10px; font-size:12px;">
                                <p><strong>Customer:</strong> ${o.customerName || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${o.customerPhone || 'N/A'}</p>
                                <p><strong>Address:</strong> ${o.address || 'N/A'}</p>
                            </div>

                            <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #f1f5f9; padding-top:15px;">
                                <button class="btn-main" style="padding:8px; font-size:12px; margin:0; background:#e0f2fe; color:#0369a1; box-shadow:none;" onclick="updateStatus('${docId}','Shipped')">Mark Shipped</button>
                                <button class="btn-main" style="padding:8px; font-size:12px; margin:0; background:#dcfce7; color:#15803d; box-shadow:none;" onclick="updateStatus('${docId}','Delivered')">Mark Delivered</button>
                            </div>
                        </div>`;
                });
                
                document.getElementById('totalPayoutAmt').innerText = "â‚¹" + Math.floor(earnings);
                document.getElementById('ordersList').innerHTML = html || "<div style='text-align:center; padding:30px; color:#94a3b8'>No orders found yet.</div>";
            });
        }

        window.updateStatus = async (id, s) => { 
            try {
                const orderRef = doc(db, "orders", id);
                await updateDoc(orderRef, { status: s });
            } catch(e) {
                alert("Error updating status: " + e.message);
            }
        };
        
        window.updateBankDetails = async () => {
            try {
                await updateDoc(doc(db, "sellers", sellerId), {
                    bankDetails: { 
                        holder: document.getElementById('accHolder').value, 
                        num: document.getElementById('accNumber').value,
                        bank: document.getElementById('bankName').value,
                        ifsc: document.getElementById('ifscCode').value
                    }
                });
                alert("Bank Details Saved!");
            } catch(e) {
                alert("Error: " + e.message);
            }
        };
    </script>
</body>
</html>
